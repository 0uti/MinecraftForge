--- ../src-base/minecraft/net/minecraft/src/RenderEngine.java	0000-00-00 00:00:00.000000000 -0000
+++ ../src-work/minecraft/net/minecraft/src/RenderEngine.java	0000-00-00 00:00:00.000000000 -0000
@@ -1,5 +1,8 @@
 package net.minecraft.src;
 
+import static org.lwjgl.opengl.GL11.GL_TEXTURE_2D;
+import static org.lwjgl.opengl.GL11.GL_TEXTURE_WIDTH;
+
 import java.awt.Color;
 import java.awt.Graphics;
 import java.awt.image.BufferedImage;
@@ -13,9 +16,13 @@
 import java.util.Iterator;
 import java.util.List;
 import java.util.Map;
+
 import javax.imageio.ImageIO;
+
 import org.lwjgl.opengl.GL11;
 
+import cpw.mods.fml.common.FMLCommonHandler;
+
 public class RenderEngine
 {
     public static boolean field_1609_a = false;
@@ -459,23 +466,40 @@
         for (int var2 = 0; var2 < this.field_1604_f.size(); ++var2)
         {
             TextureFX var3 = (TextureFX)this.field_1604_f.get(var2);
+            if (var3.field_1126_b != var1)
+            {
+                var3.func_782_a(this);
+                var1 = var3.field_1126_b;
+            }
+            Profiler.func_40663_a("hdTextureHandling");
+            int tileSize = GL11.glGetTexLevelParameteri(GL_TEXTURE_2D, 0, GL_TEXTURE_WIDTH ) >>4;
+            var3.textureGridSize = tileSize * tileSize;
+            var3.textureLength = tileSize;
+            if (var3.field_1127_a==null || var3.field_1127_a.length!= var3.textureGridSize << 2) {
+                var3.field_1127_a = new byte[var3.textureGridSize << 2];
+            }
+            Profiler.func_40662_b();
             var3.field_1131_c = this.field_1602_h.field_1578_g;
+            Profiler.func_40663_a(var3.getClass().getSimpleName());
             var3.func_783_a();
+            Profiler.func_40662_b();
+            if (var3.field_1127_a.length!=var3.textureGridSize<<2) {
+                if (!var3.hasWarned) {
+                    FMLCommonHandler.instance().getFMLLogger().warning(String.format("Detected a texture FX discrepancy in %s (%d, %d)",var3.getClass().getSimpleName(), var3.field_1127_a.length, var3.textureGridSize<<2));
+                    var3.hasWarned=true;
+                }
+                continue;
+            }
             this.field_1605_e.clear();
             this.field_1605_e.put(var3.field_1127_a);
             this.field_1605_e.position(0).limit(var3.field_1127_a.length);
 
-            if (var3.field_1126_b != var1)
-            {
-                var3.func_782_a(this);
-                var1 = var3.field_1126_b;
-            }
 
             for (int var4 = 0; var4 < var3.field_1129_e; ++var4)
             {
                 for (int var5 = 0; var5 < var3.field_1129_e; ++var5)
                 {
-                    GL11.glTexSubImage2D(GL11.GL_TEXTURE_2D, 0, var3.field_1126_b % 16 * 16 + var4 * 16, var3.field_1126_b / 16 * 16 + var5 * 16, 16, 16, GL11.GL_RGBA, GL11.GL_UNSIGNED_BYTE, this.field_1605_e);
+                    GL11.glTexSubImage2D(GL11.GL_TEXTURE_2D, 0, var3.field_1126_b % 16 * tileSize + var4 * tileSize, var3.field_1126_b / 16 * tileSize + var5 * tileSize, tileSize, tileSize, GL11.GL_RGBA, GL11.GL_UNSIGNED_BYTE, this.field_1605_e);
                 }
             }
         }
@@ -635,4 +659,8 @@
             GL11.glBindTexture(GL11.GL_TEXTURE_2D, p_1076_1_);
         }
     }
+    
+    public TexturePackList getTexturePackList() {
+        return field_6527_k;
+    }
 }
